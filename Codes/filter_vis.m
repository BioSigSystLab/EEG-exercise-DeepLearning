%load('EXE_JM1121_Matching90.mat')
load('CON_MM0221_Matching90.mat')
y1 = [0.0123  0.2497  0.5795  0.1227  0.4427];
y2 = [-0.3786 -0.3125 -0.3611 -0.2428  0.2024];
y3 = [-0.1668 -0.0716  0.2046  0.2928 -0.2902];
y4 = [0.2367  0.4855 -0.2108  0.4610 -0.1213];
y5 = [0.0143 -0.6758  0.2086 -0.1043 -0.1158];
y6 = [-0.4947  0.3413 -0.4705  0.2501  0.2754];
Y = [];
Bias1 = [-0.1678 0.3607 -0.7363 -0.0587 0.1582 0.0086];
%Bias1  = zeros(6,1);
A = squeeze(TF(13,5000,:));
figure(1); hold off;plot(A,'LineWidth',3);hold on;B1 = max(0,conv(A,y1,'same')+Bias1(1));plot(B1,'LineWidth',3);Y = [B1];
figure(2);hold off; plot(A,'LineWidth',3);hold on;B2 = max(0,conv(A,y2,'same')+Bias1(2));plot(B2,'LineWidth',3);Y = [Y B2];
figure(3);hold off; plot(A,'LineWidth',3);hold on;B3 = max(0,conv(A,y3,'same')+Bias1(3));plot(B3,'LineWidth',3);Y = [Y B3];
figure(4);hold off; plot(A,'LineWidth',3);hold on;B4 = max(0,conv(A,y4,'same')+Bias1(4));plot(B4,'LineWidth',3);Y = [Y B4];
figure(5);hold off; plot(A,'LineWidth',3);hold on;B5 = max(0,conv(A,y5,'same')+Bias1(5));plot(B5,'LineWidth',3);Y = [Y B5];
figure(6);hold off; plot(A,'LineWidth',3);hold on;B6 = max(0,conv(A,y6,'same')+Bias1(6));plot(B6,'LineWidth',3);Y = [Y B6];
Y = Y';
K = zeros(16,6,5);
K(1,:,:) = [-0.0389  0.1220 -0.0785  0.0905  0.1571;
 -0.0320  0.0425 -0.1120 -0.0909  0.1241;
 -0.1342 -0.0503  0.0469 -0.1737 -0.0208;
 -0.1625 -0.0550 -0.0464 -0.0631 -0.0214;
 -0.1734  0.0350 -0.1312 -0.0313 -0.1136;
  0.0578 -0.1145  0.1462 -0.0999 -0.0611];

K(2,:,:) = [0.1429 -0.7126 -0.0496  0.1378 -0.0842;
 -0.2252 -0.1433 -0.0112  0.1612 -0.0026;
 -0.1559  0.0042  0.0982 -0.0060  0.1694;
 -0.2896  0.0964  0.0059 -0.1469 -0.0888;
 -0.0969 -0.0105 -0.0364  0.1261 -0.0237;
  0.1857 -0.3713  0.0585  0.0636  0.0716];

K(3,:,:) = [-0.3067 -0.3333  0.1397 -0.0160  0.1263;
 -0.0237  0.2885 -0.1384 -0.0409  0.0918;
 -0.4468 -0.1071 -0.1677  0.1015  0.0033;
 -0.6077 -0.1221 -0.0650  0.0517 -0.1662;
 -0.0880  0.3260 -0.1507 -0.0427  0.1238;
  0.0249 -0.1396 -0.0773  0.0876  0.0855];

K(4,:,:) = [-0.0287  0.3632 -0.0086 -0.1635 -0.1489;
  0.2016  0.0195 -0.2013 -0.1342  0.0391;
 -0.5667 -0.2707 -0.0306 -0.0072  0.0785;
  0.0077  0.0046  0.1334 -0.0843 -0.0865;
 -0.1558  0.0451 -0.0276 -0.1080 -0.0913;
 -0.0023 -0.3279  0.0671 -0.2299 -0.0182];

K(5,:,:) = [-0.2492  0.1446  0.0027  0.1806 -0.0544;
 -0.0587  0.0134  0.0941 -0.1398  0.0011;
  0.1926 -0.0219 -0.1092  0.0327  0.1215;
 -0.0906 -0.2831  0.0434 -0.1397 -0.1226;
 -0.0106 -0.1983 -0.1162  0.0793 -0.0929;
  0.2394  0.0844 -0.0377  0.1356 -0.1841];

K(6,:,:) = [-0.0306  0.0185  0.0428  0.1459 -0.1100;
 -0.2635 -0.0091  0.1714  0.1494 -0.0943;
 -0.2767 -0.0483  0.1451 -0.1754  0.1554;
  0.1985  0.2662  0.1042  0.0792 -0.2492;
 -0.2299  0.2899  0.2188  0.1460 -0.0783;
 -0.3762  0.2636  0.0848  0.1221  0.1662];

K(7,:,:) = [-0.1205  0.1730 -0.0254  0.1568 -0.1120;
 -0.0379 -0.1262 -0.1532 -0.1072  0.0694;
  0.1175  0.1459 -0.0484  0.0587 -0.0225;
  0.3020  0.1262  0.0284  0.0395  0.0224;
 -0.0225 -0.0628 -0.0679  0.0668 -0.1441;
  0.1434  0.1073 -0.0443  0.0920 -0.0489];

K(8,:,:) = [0.1028  0.2038  0.1714  0.1082 -0.0384;
 -0.1689 -0.1213 -0.0894  0.0624 -0.1155;
 -0.0475  0.0486  0.1728  0.0663 -0.0834;
  0.1701 -0.0053 -0.0879 -0.0273 -0.0976;
 -0.4265  0.1780  0.0348 -0.1443  0.1426;
  0.1314 -0.2214 -0.1758 -0.0886  0.0668];

K(9,:,:) = [0.0587  0.0521 -0.1381 -0.0803  0.0910;
 -0.1452 -0.0808 -0.1420  0.0667 -0.0632;
  0.0548 -0.0037  0.0404 -0.1121  0.1334;
 -0.1343  0.3028  0.1586  0.0156 -0.0973;
  0.3322 -0.1063  0.1400  0.1239  0.1334;
 -0.0800 -0.0652  0.0111  0.0621  0.0535];

K(10,:,:) = [-0.9205  0.0913  0.0865 -0.0416 -0.0387;
  0.0782  0.1355 -0.0557 -0.2077 -0.1793;
  0.0933  0.2694  0.1645  0.0565 -0.0552;
 -0.0372 -0.1893  0.0230  0.2880  0.0992;
 -0.1095 -0.1561 -0.1797 -0.0198 -0.1774;
 -0.2018  0.2796  0.0223  0.0091 -0.0744];

K(11,:,:) = [-0.5088  0.2184 -0.0006 -0.0409 -0.1790;
 -0.2455 -0.1603  0.1718  0.0181 -0.0256;
 -0.5164  0.0011 -0.0292 -0.0576  0.0660;
 -0.0175  0.1322 -0.0974 -0.0126  0.0528;
 -0.1209  0.1782 -0.0170  0.0723  0.1529;
  0.0740  0.0789  0.1901  0.2535  0.1899];

K(12,:,:) = [0.3284 -0.0436 -0.1652  0.0740 -0.1494;
 -0.1803  0.2948 -0.2583 -0.0257  0.0270;
  0.2527  0.3986 -0.1129 -0.0539  0.0951;
  0.0252 -0.1998 -0.0283  0.0777  0.0128;
 -0.0096  0.0575 -0.2715 -0.1165 -0.2219;
 -0.2779 -0.0015  0.0006  0.0766  0.0298];

K(13,:,:) = [0.0447  0.2964  0.1779  0.1670  0.1812;
  0.0480  0.2659  0.1672  0.0988  0.1681;
  0.2645  0.1122 -0.0418 -0.0690  0.1011;
  0.0949 -0.0943  0.0060  0.1295  0.1148;
 -0.0079 -0.0901  0.2053  0.0971  0.1889;
 -0.1580  0.3835 -0.0096  0.1108  0.0177];

K(14,:,:) = [0.1445 -0.5374 -0.0839 -0.0578 -0.1770;
  0.0871 -0.1681 -0.2585 -0.3079 -0.1236;
  0.0958  0.3091  0.1222  0.0078  0.1545;
  0.0182  0.0537  0.0505  0.0723  0.0539;
  0.1740 -0.0942 -0.3377 -0.2164 -0.3553;
  0.2316  0.1135 -0.1255  0.0606 -0.0446];

K(15,:,:) = [-0.0452 -0.2414 -0.0879  0.1282  0.0152;
  0.2388 -0.2171  0.0078 -0.0859  0.1512;
 -0.0860 -0.1146 -0.0337 -0.0856  0.0886;
  0.0874 -0.1345  0.0701  0.0220 -0.0237;
  0.0493  0.2345  0.0433  0.0311 -0.1139;
 -0.0008  0.0624 -0.0627  0.0753 -0.0157];

K(16,:,:) = [0.0636  0.4644 -0.1817 -0.1176 -0.0938;
  0.0100 -0.0059  0.0675 -0.0953 -0.0785;
 -0.3268 -0.2263 -0.1738  0.0883 -0.0949;
 -0.3748 -0.4061 -0.1016 -0.0631 -0.0069;
  0.2040  0.1965 -0.1179 -0.0445 -0.0068;
 -0.2770  0.2145  0.1089 -0.1934  0.0140];

Bias2=[-0.1051 0.0835 -0.0948 0.1022 -0.0249 -0.0370 0.0263 0.1306 0.0269 -0.2860 -0.0172 0.0658 -0.0638 -0.1942 -0.1681 -0.0266];
out = zeros(16,55);
err=[2.9058 1.7302; 2.9479 1.7795; 3.0403 1.7242; 2.9695 1.7343; 2.6567 1.6488; 2.8934 1.8126; 1.8712 1.9015; 2.9401 1.5763; 3.6598 1.5614; 3.0468 1.7039; 2.9057 1.7305; 3.7964 0.8664; 4.9366 2.3691; 1.3082 0.8733; 2.6739 1.8280; 2.4864 2.0055; 2.9058 1.7302];
err(:,1)=err(:,1)-err(17,1);err(:,2)=err(:,2)-err(17,2);
err(:,1) = err(:,1)/sum(err(:,1));err(:,2) = err(:,2)/sum(err(:,2));
out_GAP1 = zeros(1,55);
out_GAP2 = zeros(1,55);
for i=1:1:16;
    figure(i);
    hold off;plot(A,'LineWidth',3);
    hold on;
    B = max(0,conv2(Y,squeeze(K(i,:,:)))+Bias2(i));
    B = B(6,2:56);
    out(i,:) = B;
    out_GAP1 = out_GAP1+abs(err(i,1))*out(i,:);
    out_GAP2 = out_GAP2+abs(err(i,2))*out(i,:);
    plot(B,'LineWidth',3);
end
thresh = 0.5;
thresh1 = zeros(55,1);
thresh2 = zeros(55,1);
for i=1:size(out_GAP1,2);
    if abs(out_GAP1(1,i))>=thresh*max(abs(out_GAP1))
        thresh1(i,1)=1;
    end
    if abs(out_GAP2(1,i))>=thresh*max(abs(out_GAP2))
        thresh2(i,1)=1;
    end
end
thresh1 = thresh1.*A;
thresh2 = thresh2.*A;
figure(17);hold off;
plot(A,'LineWidth',3);hold on;
plot(out_GAP1','LineWidth',3);plot(thresh1,'LineWidth',3);
%plot(out_GAP2','LineWidth',3);plot(thresh2,'LineWidth',3);
%plot(zeros(55,1));
legend('input','activation map','Thresholded output');